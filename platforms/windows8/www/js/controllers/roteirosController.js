var roteirosController=function($scope,$http){if($scope.hideBackButton=!0,$scope.enableNext=function(list){for(var i in list){var item=list[i];if(item.done=!0,!item.status_pedidos&&!item.status_sem_pedidos)break}},localStorage.load_date){var date=new Date;date.setTime(parseInt(localStorage.load_date));var today=new Date;today.setHours(0),today.setMinutes(0),date.getTime()<today.getTime()&&(localStorage.roteiros="[]",localStorage.pedidos="[]")}var loadRoteiros=function(){var lastUpdate=localStorage.sync_roteiros,forceUpdate=!1;if(lastUpdate){var today=new Date,lastUpdate=new Date(parseInt(localStorage.sync_roteiros));lastUpdate.getDate()<today.getDate()&&(forceUpdate=!0)}else forceUpdate=!0;$scope.sendingData=!0,$scope.loading=!0,$localData.findAll($http,"roteiros",forceUpdate,function(response){$scope.listItens=response.data,$scope.enableNext($scope.listItens),$scope.loading=!1;var item,tabelas=[];for(var i in $scope.listItens)item=$scope.listItens[i],-1==tabelas.indexOf(item.tabela)&&(tabelas.push(item.tabela),$localData.findAll($http,"produtos",!1,null,"tabela="+item.tabela,"produtos-"+item.tabela));$localData.defaultQuery($http,"AC5",function(response){$localData.saveAll(response.data,"eventos"),$localData.defaultQuery($http,"Z1",function(response){$localData.saveAll(response.data,"produto-familias"),$localData.defaultQuery($http,"SE4",function(response){$localData.saveAll(response.data,"condicao-pagamento"),$localData.defaultQuery($http,"ZJ2",function(response){if($localData.saveAll(response.data,"forma-recebimento"),$scope.listItens.length){var percurso=$scope.listItens[0].percurso;$localData.defaultQuery($http,"SA1",function(response){$localData.saveAll(response.data,"clientes"),$scope.sendingData=!1},"filter=a1_zrota:"+percurso)}else $scope.sendingData=!1})})})})})};loadRoteiros();var sendButton=document.createElement("button");sendButton.classList.add("ion-loop"),sendButton.style.position="absolute",sendButton.style.right="8px",sendButton.style.top="8px";document.getElementsByTagName("ion-nav-bar")[0];$scope.sendData=function(){$scope.sendModels("pedidos","pedido",function(){$scope.sendModels("sem_pedidos","sem_pedido")})},$scope.sendModels=function(type,apiModel,success){if($scope.sendingData)return 0;$scope.sendingData=!0;var models=$localData.findAll($http,type,!1);for(var i in models){var model=models[i];model.errors&&delete model.errors}$localData.saveAll(models,type);var send=function(callback){models=$localData.findAll($http,type,!1);var model=models[0],allWithError=!0;for(var i in models){var errors=models[i].errors;if(!errors){allWithError=!1,model=models[i];break}}if(allWithError||!models.length)return callback(),0;var data=$localData.serialize(apiModel,model);$http.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",$http.post(API_URL+"/"+type+".json",data+"&user_email="+localStorage.user_email+"&user_token="+localStorage.user_token).success(function(){$localData.delete($http,type,"__id",model.__id),$scope.sendingData=!1;var roteiro=$localData.find($http,"roteiros","sequencia",model.__roteiro);roteiro["status_"+type]=STATUS_SENT,roteiro.errors="",$localData.update($http,"roteiros","sequencia",roteiro),send(callback)}).error(function(data){if(data.base){var roteiro=$localData.find($http,"roteiros","sequencia",model.__roteiro);roteiro["status_"+type]=STATUS_SENT_ERROR,roteiro.errors=data.base.join(" "),$localData.update($http,"roteiros","sequencia",roteiro),model.errors=data.base.join(" "),$localData.update($http,type,"__id",model),send(callback)}else{var roteiro=$localData.find($http,"roteiros","sequencia",model.__roteiro);roteiro["status_"+type]=STATUS_SENT_ERROR,roteiro.errors="Sem rede",$localData.update($http,"roteiros","sequencia",roteiro),model.errors="Sem rede",$localData.update($http,type,"__id",model),send(callback)}})};send(function(){$scope.sendingData=!1,loadRoteiros(),success&&success()})},window.syncronize&&$scope.sendData();setTimeout(function(){$scope.sendData()},6e4)};